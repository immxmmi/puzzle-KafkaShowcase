<canvas id="trafficCanvas" width="1600" height="1000"></canvas>
<script>
const debugMode = false;
const canvas = document.getElementById('trafficCanvas');
const ctx = canvas.getContext('2d');

let trafficData = {
  carsPerMinute: 100,
  averageSpeed: 50,
  trafficDensity: 0.4,
  incidentReported: false,
};

let cars = [];

class Car {
  constructor(x, y, width, height, color, speed) {
    this.x = x;
    this.y = y;
    this.width = width;
    this.height = height;
    this.color = color;
    this.speed = speed;
  }
  draw() {
    ctx.save();
    ctx.translate(this.x, this.y);

    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(this.width, 0);
    ctx.lineTo(this.width - 5, this.height);
    ctx.lineTo(5, this.height);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,0.1)";
    ctx.fillRect(5, 2, this.width - 10, 4);

    ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
    ctx.fillRect(5, this.height, this.width - 10, 5);

    ctx.restore();
  }
  update() {
    this.x += this.speed;
  }
}

class EmergencyCar extends Car {
  constructor(x, y, width, height) {
    super(x, y, width, height, 'red', 4.5);
    this.lightOn = false;
    setInterval(() => {
      this.lightOn = !this.lightOn;
    }, 400);
  }
  draw() {
    super.draw();
    ctx.save();
    ctx.translate(this.x, this.y);

    ctx.fillStyle = this.lightOn ? "cyan" : "rgba(0,255,255,0.2)";
    ctx.beginPath();
    ctx.arc(this.width / 2, -5, 5, 0, 2 * Math.PI);
    ctx.fill();

    if (trafficData.trafficDensity > 0.8) {
      ctx.fillStyle = "red";
      ctx.font = "bold 16px sans-serif";
      ctx.fillText("Hup! Hup!", this.width + 10, 0);
    }

    ctx.restore();
  }
}

async function fetchDataAndUpdate() {
  if (debugMode) {
    trafficData = {
      carsPerMinute: Math.floor(Math.random() * 300),
      averageSpeed: Math.random() * 100 + 30,
      trafficDensity: Math.random(),
      incidentReported: Math.random() < 0.2,
    };
    return;
  }

  try {
    const res = await fetch("/api/data");
    const json = await res.json();
    if (json.length > 0) {
      const latest = json[json.length - 1];
      trafficData = {
        carsPerMinute: latest.carsPerMinute || 0,
        averageSpeed: latest.averageSpeed || 0,
        trafficDensity: latest.trafficDensity || 0,
        incidentReported: latest.incidentReported || false,
      };
    }
  } catch (e) {
    console.error("API fetch failed", e);
  }
}

function drawRoad() {
  ctx.fillStyle = "#444";
  ctx.fillRect(0, canvas.height / 3, canvas.width, canvas.height / 3);

  ctx.strokeStyle = "#888";
  ctx.lineWidth = 1.5;
  for (let i = 1; i < 3; i++) {
    const y = canvas.height / 3 + i * (canvas.height / 9);
    ctx.setLineDash([15, 15]);
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(canvas.width, y);
    ctx.stroke();
  }

  ctx.setLineDash([20, 20]);
  ctx.strokeStyle = "white";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(0, canvas.height / 2);
  ctx.lineTo(canvas.width, canvas.height / 2);
  ctx.stroke();
  ctx.setLineDash([]);

  // Gebäude korrekt auf Boden platzieren
  for (let i = 0; i < canvas.width; i += 80) {
    ctx.fillStyle = `hsl(${Math.random() * 360}, 30%, 30%)`;
    const h = 60 + Math.random() * 60;
    ctx.fillRect(i, 240 - h, 50, h);
  }

  // Bäume auf Naturstraße
  for (let i = 0; i < canvas.width; i += 80) {
    ctx.fillStyle = "#8B4513"; // Stamm
    ctx.fillRect(i + 10, 670, 10, 30);
    ctx.beginPath();
    ctx.arc(i + 15, 665, 20, 0, 2 * Math.PI);
    ctx.fillStyle = "green";
    ctx.fill();
  }
}

function drawTrafficLight() {
  const isRed = trafficData.trafficDensity > 0.8;
  ctx.beginPath();
  ctx.arc(canvas.width - 50, 60, 15, 0, 2 * Math.PI);
  ctx.fillStyle = isRed ? "red" : "limegreen";
  ctx.fill();
  ctx.strokeStyle = "#222";
  ctx.lineWidth = 2;
  ctx.stroke();
}

function drawWarning() {
  if (trafficData.trafficDensity > 0.4 || trafficData.incidentReported) {
    ctx.font = "bold 60px sans-serif";
    ctx.fillStyle = "white";
    ctx.fillText("STAU", canvas.width / 2 - 110, 82);
    ctx.strokeStyle = "red";
    ctx.lineWidth = 3;
    ctx.strokeText("STAU", canvas.width / 2 - 110, 82);
  }
}

function spawnCars() {
  const numCars = Math.floor(trafficData.carsPerMinute / 40);
  const lanes = [330, 360, 530, 560, 730, 760]; // zwei pro Straße

  for (let i = 0; i < numCars; i++) {
    const laneY = lanes[Math.floor(Math.random() * lanes.length)];
    const color = `hsl(${Math.random() * 360}, 70%, 55%)`;
    const width = 40 + Math.random() * 30;
    const height = 20;
    const speed = (trafficData.averageSpeed / 80) + Math.random();
    cars.push(new Car(-50, laneY, width, height, color, speed));
  }

  if (trafficData.incidentReported) {
    cars.push(new EmergencyCar(-50, 530, 50, 20));
  }
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawRoad();
  drawTrafficLight();
  drawWarning();

  cars.forEach(car => {
    car.update();
    car.draw();
  });

  cars = cars.filter(car => car.x < canvas.width + 100);

  if (Math.random() < 0.4) {
    spawnCars();
  }

  requestAnimationFrame(animate);
}

fetchDataAndUpdate();
setInterval(fetchDataAndUpdate, 3000);
requestAnimationFrame(animate);
</script>